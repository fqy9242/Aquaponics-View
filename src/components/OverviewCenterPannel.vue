<script setup>
import * as echarts from 'echarts';
import { ref, onMounted, onUnmounted } from 'vue';
import $ from 'jquery'; 
//定义DOM引用和图表实例
const chartDom = ref(null);
let myChart = null;

var geoCoordMap = {
    '南宁市': [108.320004, 22.82402],
    '百色市': [106.616285, 23.897742],
    '河池市': [108.062105, 24.695899],
    '柳州市': [109.411703, 24.314617],
    '桂林市': [110.299121, 25.274215],
    '崇左市': [107.353926, 22.404108],
    '来宾市': [109.229772, 23.733766],
    '贵港市': [109.602146, 23.0936],
    '贺州市': [111.552056, 24.414141],
    '梧州市': [111.297604, 23.474803],
    '防城港市': [108.000478, 21.914631],
    '钦州市': [108.624175, 21.967127],
    '北海市': [109.339254, 21.653343],
    '玉林市': [110.154393, 22.63136],
}
var customerBatteryCityData = [
    { name: '南宁市', value: 70 },
    { name: '百色市', value: 39 },
    { name: '河池市', value: 70 },
    { name: '柳州市', value: 70 },
    { name: '桂林市', value: 89 },
    { name: '崇左市', value: 52 },
    { name: '来宾市', value: 9 },
    { name: '贵港市', value: 70 },
    { name: '贺州市', value: 99 },
    { name: '梧州市', value: 39 },
    { name: '防城港市', value: 70 },
    { name: '钦州市', value: 34 },
    { name: '北海市', value: 62 },
    { name: '玉林市', value: 98 },
];
var mapData = [
    { name: '南宁', value: 70 },
    { name: '百色', value: 39 },
    { name: '河池', value: 70 },
    { name: '柳州', value: 70 },
    { name: '桂林', value: 89 },
    { name: '崇左', value: 52 },
    { name: '来宾', value: 9 },
    { name: '贵港', value: 70 },
    { name: '贺州', value: 99 },
    { name: '梧州', value: 39 },
    { name: '防城港', value: 70 },
    { name: '钦州', value: 34 },
    { name: '北海', value: 62 },
    { name: '玉林', value: 98 },
]
const dataMap = mapData.reduce((map, item) => (map[item.name] = item.value, map), {});

const generateChartData = () => {
    const maxValue = Math.max(...customerBatteryCityData.map(item => item.value));
    const lineMaxHeight = 0.9 / maxValue;

    const lineData = customerBatteryCityData.map(item => ({
        coords: [
            geoCoordMap[item.name],
            [geoCoordMap[item.name][0], geoCoordMap[item.name][1] + item.value * lineMaxHeight]
        ]
    }));

    const scatterData = customerBatteryCityData.map(item => [
        geoCoordMap[item.name][0],
        geoCoordMap[item.name][1] + item.value * lineMaxHeight,
        item.value
    ]);

    const scatterData2 = customerBatteryCityData.map(item => ({
        name: item.name,
        value: geoCoordMap[item.name]
    }));

    return { lineData, scatterData, scatterData2 };
};

// --- 4. 初始化图表（使用 jQuery）---
const initChart = () => {
    if (!chartDom.value) return;

    // 使用 jQuery 加载地图数据
    $.getJSON("src/assets/json/450000.json")
        .done((geoJson) => {
            // 注册地图
            echarts.registerMap('guangxi', geoJson);

            // 生成动态数据
            const { lineData, scatterData, scatterData2 } = generateChartData();

            // 配置项
            const option = {
                tooltip: {
                    trigger: 'item',
                    show: true,
                    enterable: true,
                    textStyle: {
                        fontSize: 20,
                        color: '#fff'
                    },
                    backgroundColor: 'rgba(0,2,89,0.8)',
                    formatter: function (params) {
                        if (typeof (params.value)[2] == "undefined") {
                            return params.name + ' : ' + dataMap[params.name];
                        } else {
                            return params.name + ' : ' + params.value[2];
                        }
                    }
                },
                geo: [
                    {
                        map: 'guangxi',
                        aspectScale: 0.9,
                        roam: true, // 是否允许缩放
                        zoom: 1.2, // 默认显示级别
                        layoutSize: '95%',
                        layoutCenter: ['55%', '50%'],
                        itemStyle: {
                            normal: {
                                areaColor: {
                                    type: 'linear-gradient',
                                    x: 0,
                                    y: 300,
                                    x2: 0,
                                    y2: 0,
                                    colorStops: [{
                                        offset: 0,
                                        color: 'rgba(50, 200, 50, 0.3)' // 0% 处的颜色
                                    }, {
                                        offset: 1,
                                        color: 'rgba(152, 251, 152, 0.3)' // 50% 处的颜色
                                    }],
                                    global: true // 缺省为 false
                                },
                                borderColor: '#FFFACD',
                                borderWidth: 1
                            },
                            emphasis: {
                                areaColor: '#C0FF3E'
                            },
                        },
                        emphasis: {
                            itemStyle: {
                                areaColor: '#0160AD',
                            },
                            label: {
                                show: 0,
                                color: '#fff'
                            }
                        },
                        zlevel: 3
                    }
                ],
                series: [
                    // map
                    {
                        geoIndex: 0,
                        // coordinateSystem: 'geo',
                        showLegendSymbol: true,
                        type: 'map',
                        roam: true,
                        label: {
                            normal: {
                                show: false,
                                textStyle: {
                                    color: '#fff'
                                }
                            },
                            emphasis: {
                                show: false
                            }
                        },

                        itemStyle: {
                            normal: {
                                borderColor: '#2ab8ff',
                                borderWidth: 1.5,
                                areaColor: '#12235c'
                            },
                            emphasis: {
                                areaColor: '#2AB8FF',
                                borderWidth: 0,
                                color: 'red'
                            }
                        },
                        map: 'guangxi', // 使用
                        data: customerBatteryCityData
                        // data: this.difficultData //热力图数据   不同区域 不同的底色
                    },
                    // 柱状体的主干
                    {
                        type: 'lines',
                        zlevel: 5,
                        effect: {
                            show: false,
                            // period: 4, //箭头指向速度，值越小速度越快
                            // trailLength: 0.02, //特效尾迹长度[0,1]值越大，尾迹越长重
                            // symbol: 'arrow', //箭头图标
                            // symbol: imgDatUrl,
                            symbolSize: 5 // 图标大小
                        },
                        lineStyle: {
                            width: 20, // 尾迹线条宽度
                            color: 'rgb(22,255,255, .6)',
                            opacity: 1, // 尾迹线条透明度
                            curveness: 0 // 尾迹线条曲直度
                        },
                        label: {
                            show: 0,
                            position: 'end',
                            formatter: '245'
                        },
                        silent: true,
                        data: lineData
                    },
                    // 柱状体的顶部
                    {
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        geoIndex: 0,
                        zlevel: 5,
                        label: {
                            show: true,
                            formatter: function (params) {
                                return params.value[2]
                            },
                            position: "top"
                        },
                        symbol: 'circle',
                        symbolSize: [20, 10],
                        itemStyle: {
                            color: 'rgb(22,255,255, 1)',
                            opacity: 1
                        },
                        silent: true,
                        data: scatterData
                    },
                    // 柱状体的底部
                    {
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        geoIndex: 0,
                        zlevel: 4,
                        label: {
                            // 这儿是处理的
                            formatter: '{b}',
                            position: 'bottom',
                            color: '#fff',
                            fontSize: 15,
                            distance: 10,
                            show: true
                        },
                        symbol: 'circle',
                        symbolSize: [20, 10],
                        itemStyle: {
                            // color: '#F7AF21',
                            color: 'rgb(22,255,255, 1)',
                            opacity: 1
                        },
                        silent: true,
                        data: scatterData2
                    },
                    // 底部外框
                    {
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        geoIndex: 0,
                        zlevel: 4,
                        label: {
                            show: false
                        },
                        symbol: 'circle',
                        symbolSize: [40, 20],
                        itemStyle: {
                            color: {
                                type: 'radial',
                                x: 0.5,
                                y: 0.5,
                                r: 0.5,
                                colorStops: [
                                    {
                                        offset: 0, color: 'rgb(22,255,255, 0)' // 0% 处的颜色
                                    },
                                    {
                                        offset: .75, color: 'rgb(22,255,255, 0)' // 100% 处的颜色
                                    },
                                    {
                                        offset: .751, color: 'rgb(22,255,255, 1)' // 100% 处的颜色
                                    },
                                    {
                                        offset: 1, color: 'rgb(22,255,255, 1)' // 100% 处的颜色
                                    }
                                ],
                                global: false // 缺省为 false
                            },

                            opacity: 1
                        },
                        silent: true,
                        data: scatterData2
                    }
                ]
            };

            // 销毁旧实例
            if (myChart) myChart.dispose();

            // 初始化图表
            myChart = echarts.init(chartDom.value);
            myChart.setOption(option);
        })
        .fail((jqXHR, textStatus, errorThrown) => {
            console.error('地图加载失败:', textStatus, errorThrown);
        });
};

// --- 5. 生命周期管理 ---
onMounted(() => {
    initChart();
    window.addEventListener('resize', () => myChart?.resize());
});

onUnmounted(() => {
    window.removeEventListener('resize', () => myChart?.resize());
    myChart?.dispose();
});
</script>

<template>
    <div class="panel-box water-quality-panel">
        <div class="panel-title">
            <svg t="1740282652579" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="24899" width="33" height="33">
                <path
                    d="M589.047957 214.815025c1.451453-0.241909 6.531538 2.902906 7.257264 3.144814 40.64068 12.337349 54.429483 9.676352 104.020789 38.947319 46.446492 27.577605 69.669738 48.86558 101.359792 88.538625 68.218285 85.151902 88.780534 205.864399 56.122844 312.062367-20.078431 65.07347-55.155209 112.487597-104.020789 157.482637-8.466808 7.741082-24.190881 14.756438-24.190881 28.787148 0 13.304985 17.175526 42.575951 44.511221 19.594614l43.543587-40.64068c14.756438-14.514529 38.70541-47.172218 49.591306-65.557288 104.262698-174.900071 59.751476-389.231278-96.763525-514.298134-46.204583-37.012048-134.501299-77.41082-193.28514-77.41082 7.499173-10.885897 18.626979-14.514529 18.626978-31.206236 0-14.998346-9.676352-24.916608-24.916607-24.916608-17.659343 0-68.460194 51.284668-68.460194 74.749823 0 23.707064 13.304985 33.625325 25.884243 45.962674 10.16017 10.16017 25.400425 31.931963 42.575951 31.931963 24.916608 0 34.109142-29.996693 15.724072-43.543586l2.419089-3.628632zM138.613749 529.538389c0 78.136546 1.209544 119.261044 35.076778 191.833688 18.143161 38.70541 43.059768 74.749823 71.363099 103.053153 60.235294 59.751476 139.581384 111.519962 229.571463 119.019136-8.950626 16.691708-15.965982 17.417434-17.659344 29.029057-1.209544 8.708717 7.015356 26.851878 23.707064 26.851878 20.804158 0 74.749823-63.380109 74.749823-74.749823 0-25.158516-76.685093-114.422868-97.005434-62.170564-4.596267 11.853532 0.483818 18.626979 6.773447 28.061422-49.833215-4.11245-115.148594-40.64068-152.886369-71.121191-65.315379-52.736121-124.09922-151.193007-124.09922-249.407985 0-83.942358 12.821167-139.339476 54.671391-203.44531 18.143161-27.335696 31.448146-39.673045 53.461847-61.686747 8.2249-8.2249 22.497519-18.868887 26.60997-29.996693 5.321994-14.756438-8.466808-31.448146-22.739429-31.448145-33.141507 0-93.61871 86.361446-110.068509 113.697141-24.916608 41.124498-51.526577 108.375148-51.526577 172.480983z"
                    p-id="24900" fill="#1afa29"></path>
                <path
                    d="M348.348689 364.31467c14.756438-0.725726 30.964328 16.20789 40.398771 26.126152 11.369714 11.611623 19.836523 24.43279 28.061423 39.914954 1.93527 3.870541 9.918261 20.32034 8.950626 24.43279-2.660997 10.16017-34.834869 38.221592-62.170565 39.914954-27.577605 1.451453-40.156863 1.209544-64.831562-15.482164-2.902906-1.93527-15.724073-13.063076-16.933616-16.20789-1.451453-3.870541 4.596267-21.046067 6.04772-25.400426 8.466808-22.013702 27.577605-54.9133 47.656036-68.702102 2.902906-1.93527 8.708717-4.354359 12.821167-4.596268z m83.700449 112.971416c1.451453 25.642334 4.11245 43.059768-3.870541 70.637373-18.38507 62.170565-54.187574 67.976376-37.737775 93.860618 6.773447 10.643988 17.901252 7.982991 32.899599 28.303331 11.127805 14.998346 19.836523 47.414127 6.289629 43.059769-2.419088-0.725726-45.962674-40.882589-101.117884-9.192535-10.16017 5.805811-19.110796 15.240255-21.287975 16.20789-14.514529 6.289629-9.192535-41.850224 18.38507-63.380108 6.04772-4.596267 16.449799-10.643988 15.240255-23.948973-1.451453-19.110796-31.206237-28.54524-49.591307-74.749822-11.853532-29.270966-11.369714-40.156863-13.304984-72.088826 5.321994 3.144815 9.918261 7.499173 15.482164 11.127805 41.366407 27.335696 93.61871 21.287975 131.114576-12.821167 2.419088-2.419088 5.321994-5.321994 7.499173-7.015355z m-83.700449-130.872668c-21.529884 1.209544-35.076778 16.933617-47.172218 32.173872-9.918261 12.579258-9.676352 12.095441-18.868888 27.577605-33.141507 56.848571-28.54524 132.807938 7.499173 187.963147l15.240256 19.836522c7.982991 9.434444 16.933617 13.546893 17.175525 20.804158 0.241909 3.870541-8.466808 7.982991-15.482164 14.756437-5.080085 4.596267-9.918261 11.611623-13.546893 17.659344-7.015356 12.095441-13.304985 29.754784-12.33735 48.381762 1.209544 17.417434 21.529884 32.173872 40.398772 16.933617 2.177179-1.93527 2.902906-3.144815 5.080085-5.080085 20.562249-18.626979 52.97803-22.255611 77.652729-9.434444 8.466808 4.596267 17.659343 14.27262 26.851878 13.788802 13.546893-0.725726 25.158516-12.095441 24.43279-24.916607-0.967635-18.626979-9.192535-36.528231-17.175526-47.172218s-13.788802-15.724073-24.43279-22.49752c-11.369714-7.257264-12.579258-6.04772 0.241909-22.497519 3.628632-4.596267 6.773447-8.2249 9.918261-13.304985 2.902906-5.321994 5.321994-9.192535 8.2249-14.998346 27.577605-52.010395 26.36806-114.664777-0.967636-167.400898-14.030711-26.851878-52.252303-74.266005-82.732813-72.572644z"
                    p-id="24901" fill="#1afa29"></path>
                <path
                    d="M351.735412 423.582329c-22.255611 1.209544-14.756438 27.819513 0.483818 26.851878 6.531538-0.241909 12.821167-8.2249 12.579258-15.240255-0.241909-4.838176-7.257264-11.853532-13.063076-11.611623zM593.644224 754.513584c-33.383416 16.933617-30.48051 18.626979-41.366407-2.902906-15.965982-31.448146 10.643988-71.121191 25.642334-97.973069l41.608316-77.168911c1.693362-3.628632 3.628632-8.950626 6.289629-11.369714 16.20789 32.173872 5.563903 61.202929 3.628632 101.117883-2.177179 42.334042 4.838176 67.734467-35.802504 88.296717z m120.228679-262.954879c4.838176-2.419088 4.838176-19.110796 12.821167-31.690054 7.982991-11.853532 22.013702-14.998346 35.802505-17.175526 27.819513-4.11245 45.236948 3.628632 60.96102 34.834869 8.2249 16.449799 11.853532 30.722419 9.434444 43.785495-4.838176 28.787149-30.722419 41.850224-58.300024 42.092133-4.838176 0-7.982991-0.483818-12.337349-0.725726-17.417434-1.451453-14.998346 0-18.38507 9.434444-3.386723 8.708717-14.030711 19.594614-22.013702 24.43279-11.611623 7.015356-32.173872 17.901252-40.882589 0.725726-0.967635-1.93527 1.93527-19.594614 2.660997-22.255611 6.773447-23.465155 40.882589-38.70541 65.557288-51.042759l27.819513-14.27262c6.773447-3.386723 5.321994 0.241909 10.643988-6.531538-3.144815-11.853532-4.354359-14.27262-30.722419-0.725726-22.981337 11.611623-50.317033 23.948972-69.427829 40.398771-12.095441 10.402079-13.788802 14.756438-18.38507 28.061423-9.918261 30.48051-1.451453 69.427829-1.209544 102.085518 0.241909 16.449799-6.531538 49.349398-14.514529 63.622018-8.708717 15.724073-20.804158 26.126152-39.673045 30.722419-5.563903 1.451453-8.2249 0.967635-12.337349 2.177179 0.483818-4.11245-0.241909-2.419088 4.838176-5.080085 3.144815-1.693362 4.596267-2.177179 7.499173-4.354359 4.838176-3.386723 8.466808-6.289629 12.095441-10.16017 13.304985-13.788802 16.20789-30.964328 17.175526-49.349397 0.483818-9.434444 0.725726-18.143161 1.451452-27.819514 1.451453-17.659343 6.773447-67.976376 5.563903-81.28136-3.386723-39.431136-24.43279-37.012048-17.659343-60.719112 3.386723-11.853532 9.918261-15.240255 19.352705-23.707064 12.337349-10.885897 0.725726-1.93527 14.27262-8.708717 27.577605-13.546893 40.64068-3.144815 47.897944-6.773447z m-63.622017-14.030711c-9.918261-19.836523-21.046067-28.061422-21.771793-40.64068-0.483818-7.741082-6.289629-19.594614-10.16017-27.335696l8.950626-18.868887c13.304985-19.594614 39.431136-26.126152 60.719112-20.32034 29.754784 7.741082 39.189227 30.964328 39.673045 59.02575 0 5.080085 1.209544 6.531538-2.660997 10.16017-3.386723 3.144815-5.563903 4.354359-8.2249 7.982991-2.177179 2.419088-4.11245 6.289629-5.563903 8.950626-2.177179 4.354359-5.805811 14.998346-6.289629 19.594613-19.836523-0.241909-18.143161-0.725726-37.979683 4.354359 0.483818-4.11245 1.93527-7.257264 3.144814-11.611623 1.693362-4.838176 9.434444-32.65769 7.982991-35.560595-2.902906-5.805811-6.773447-5.321994-11.611623-2.902906-4.354359 2.177179-12.095441 39.914954-16.20789 47.172218z m-194.252776-14.514528c9.434444 18.38507 23.707064 29.270966 40.64068 36.044413 5.080085 2.177179 12.095441 2.177179 16.207891 4.112449-6.531538 5.805811-4.11245 28.787149 0.241909 37.495866l5.080085 9.918261c6.289629 12.579258 23.223246 24.190881 34.59296 21.529885 2.177179-3.144815 4.354359-6.531538 1.693361-10.885897-2.660997-4.11245-19.836523-4.596267-26.36806-23.948972-3.386723-10.16017-5.321994-15.965982-3.144815-24.190881 2.419088-9.434444 11.853532-14.756438 8.2249-21.529885-2.177179-4.596267-12.337349-3.144815-17.175526-3.386723-36.286322-1.209544-55.880936-39.914954-53.703756-67.25065 0.967635-10.16017 5.080085-18.38507 11.853532-26.851878 26.36806-33.625325 93.134893-46.204583 115.632412-6.531538 7.257264 12.821167 23.223246 40.398772 22.739428 52.494213-0.241909 6.531538-3.628632 6.531538-3.870541 14.514528 3.386723 4.354359 6.773447 5.321994 12.095441 4.11245 5.563903 10.885897 13.063076 20.804158 19.594614 33.867234 3.870541 7.741082-27.093787 13.788802-24.916608 50.80085 0.241909 5.563903 0.725726 3.870541-1.693362 8.708717-10.643988 21.771793-18.143161 37.253957-29.996692 58.541933-11.369714 20.078431-32.173872 57.574297-41.124498 79.587999-3.870541 9.918261-8.950626 21.046067-9.918262 31.690054-0.483818 3.628632 0.241909 5.805811-2.660997 8.466809-22.981337-45.478857-18.626979-57.816206 2.660997-95.79589 17.417434-30.964328 47.172218-58.541932 58.300024-78.378455 19.594614-35.318687-7.499173-86.845263-27.577605-126.2764-1.209544-2.419088-0.967635-0.967635-2.902905-3.628632-15.965982 4.11245-11.369714 7.257264-0.725727 33.141507 7.257264 17.901252 17.417434 36.770139 21.771793 55.397118 7.015356 31.931963-8.950626 44.511221-29.270966 67.008741-9.192535 10.402079-14.998346 20.078431-22.255611 30.964328-3.870541 5.563903-7.015356 10.643988-9.918261 15.965982-3.144815 5.321994-6.04772 10.402079-8.950626 16.20789-18.38507 37.253957-13.546893 55.639027 3.870541 90.473896 6.531538 12.821167 33.141507 49.833215 50.075124 47.897944 28.54524-3.386723 41.124498 6.289629 69.18592-7.98299 16.20789-8.2249 25.400425-20.804158 31.448146-32.173872 5.805811-10.885897 10.402079-27.093787 12.579258-39.189228 2.660997-15.240255 4.596267-25.642334 3.628632-42.092133l-1.451453-45.478857c6.289629 6.773447 27.093787 3.870541 35.076778-0.241909 12.095441-6.04772 20.804158-10.16017 29.996693-21.046066 15.724073-18.626979 4.11245-19.110796 24.190881-17.417435 35.318687 2.660997 67.976376-16.449799 77.41082-51.768485 1.93527-7.741082 2.177179-17.417434 0.241908-26.368061-0.725726-3.870541-2.419088-10.643988-4.112449-14.756437-1.93527-5.080085-4.11245-11.127805-6.289629-15.482164-2.902906-5.805811-13.546893-21.529884-18.143161-26.126152-7.499173-7.257264-13.304985-10.402079-22.255611-13.304985-14.998346-4.838176-23.707064-4.596267-39.189228-2.177179-4.596267 0.725726-10.643988 2.660997-14.272619 2.660997-0.967635-3.628632-0.483818-5.321994-0.725727-8.466808-3.386723-31.931963-17.901252-58.541932-51.284668-66.283015-7.015356-1.693362-16.933617-2.902906-24.43279-2.177179-28.303331 2.660997-43.543586 12.821167-56.848571 36.52823-5.805811-11.127805-13.546893-21.046067-21.287975-26.851878-16.933617-12.821167-35.318687-17.175526-56.606662-14.998346-23.948972 2.660997-50.317033 14.514529-66.524923 32.899598-20.32034 23.465155-23.948972 53.219939-9.434444 82.007088z"
                    p-id="24902" fill="#1afa29"></path>
            </svg>
            鱼菜共生运营基地
        </div>
        <div ref="chartDom" class="chart-container"></div>
    </div>
</template>

<style scoped>
.chart-container {
    width: 100%;
    height: 960px;
}
.panel-title {
    display: flex;
    align-items: center;
}
.panel-title .icon {
    margin-right: 10px; /* 调整这个值来控制图标与标题的距离 */
}
</style>